    <link rel="import" href="../polymer/polymer.html">

<!--

`<hot-form-validator>` is an element meant to wrap a `<form is="iron-form">`
element, to set fields as invalid (with the correct error message) if the server
returns an error

    <hot-form-validator>
      <form is="iron-form" id="form" method="post" action="/stores/polymer">
        <paper-input required id="name" name="name" label="Your name"></paper-input>
        <paper-input required id="surname" name="surname" label="Your surname"></paper-input>
        <paper-button type="submit" raised on-click="_submit">Click!</paper-button>
      </form>
    </hot-form-validator>

The element works by listening to the `on-iron-form-submit` and `on-iron-form-error`
to see what the server has returned: in case of success, it displays a
customisable "Success!"; in case of error, it looks at the server response sets
the problematic field as `invalid`, as well as setting the error messages.

    <hot-form-validator success-message="Record saved!">
      <form is="iron-form" id="form" method="post" action="/stores/polymer">
        <paper-input required id="name" name="name" label="Your name"></paper-input>
        <paper-input required id="surname" name="surname" label="Your surname"></paper-input>
        <paper-button type="submit" raised on-click="_submit">Click!</paper-button>
      </form>
    </hot-form-validator>

The message is provided with a `<paper-toast>` widget that will be looked for
as follows:

 - If `global-toast` is passed, then it will be searched in `document`
 - Otherwise, it will be searched within the widget

In terms of searching:

 - If `toast-id` is passed, it will be searched by the corresponding `id` field
 - Otherwise, it will be the first `<paper-toast>` widget found.

For example:

    <hot-form-validator global-toast>
    ...
    </hot-form-validator>

    <hot-form-validator global-toast toast-id="some-global-toast">
    ...
    </hot-form-validator>

    <hot-form-validator toast-id="some-toast">
    ...
    </hot-form-validator>

The server response could be 422; for this widget to set the errors properly,
the return message must be in the following format:

    {"message":"Unprocessable Entity","errors":[{"field":"name","message":"Not good!"}]}

This will cause `hot-form-validator` to display the error message `Unprocessable Entity`
and set the field named `name` as `invalid`, with the invalid message set as
`Not good!`.

All automatically as it should be.

NOTE: sane-submit will make sure that 1) An invisible button is added to the form
so that pressing enter on the input fields will submit 2) When the paper-button
element in the form marked as "submit" is pressed, the form is submitted.
This option is still undocumented

@group Hotplate Elements
@element hot-form-validator
@demo demo/index.html
-->


<dom-module id="hot-form-validator">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <div on-iron-form-response="_formSubmitted" on-iron-form-error="_formError" id="content">
      <content></content>
    </div>

  </template>

  <script>
    Polymer({

      is: 'hot-form-validator',

      properties: {

        /**
         * The ID of the paper-toast element
        */
        toastId: String,

        /**
         * If set to `true`, the toast element will be searched in the
         * `document` rather than within the widget
        */
        globalToast: Boolean,


        errorToastId: String,

        /**
         * If set to `true`, an invisible button will be added to
         * this form, with "type='submit'. ALSO when a paper-button
         * in the form marked as "type=submit" is pressed, the form
         * will get submitted
        */
        saneSubmit: Boolean,

        /**
         * Message given in case of success
        */
        successMessage: {
          type: String,
          value: "Success!"
        }
      },


      attached: function(){

        // Add submit button if so required
        if( this.saneSubmit ){

          // Add a listener so that clicking on this button implies a submit
          var paperButton = this.form.queryEffectiveChildren('paper-button[type=submit]');
          if( paperButton ){
            this.listen( paperButton, 'tap', '_onPaperButtonTap');
          }
        }

      },

      detached: function(){
        var paperButton = this.form.queryEffectiveChildren('paper-button[type=submit]');
        if( paperButton ){
          this.unlisten( paperButton, 'tap', '_onPaperButtonTap');
        }
      },

      // Submit the form when the right button is tapped
      _onPaperButtonTap: function(){
        this.form.submit();
      },

      ready: function(){

        // Sets the form
        this.form = this.queryEffectiveChildren( 'form' );

        // Add a button element, to make "enter" work
        // if saneSubmit is set
        // This is in ready() since it only needs to happen once
        if( this.saneSubmit ){
          var button = document.createElement('button');
          button.setAttribute( 'type', 'submit');
          button.setAttribute( 'style', 'display: none;');
          Polymer.dom( this.form ).appendChild( button )
        }

        // GLOBAL TOAST
        // Using a global toast, maybe with ID and maybe without
        if( this.globalToast ){

          if( this.toastId ){
            this.toast = document.querySelector( '#' + this.toastId );
          } else {
            this.toast = document.querySelector( 'paper-toast');
          }

          // Sets the errorToast. It will be the same as this.toast,
          // unless error-toast-id is specified
          if( this.errorToastId ){
            this.errorToast = document.querySelector( '#' + this.errorToastId );
          } else {
            this.errorToast = this.toast;
          }

        // LIGHT DOM TOAST
        // Using a toast in the light DOM, maybe with ID and maybe without
        } else {
          if( this.toastId ){
            this.toast = this.queryEffectiveChildren( '#' + this.toastId );
          } else {
            this.toast = this.queryEffectiveChildren( 'paper-toast' );
          }

          // Sets the errorToast. It will be the same as this.toast,
          // unless error-toast-id is specified
          if( this.errorToastId ){
            this.errorToast = this.queryEffectiveChildren( '#' + this.errorToastId );
          } else {
            this.errorToast = this.toast;
          }
        }

        //console.log("TOAST:", this.toast );
        //console.log("ERROR TOAST:", this.errorToast );

      },

      _toastMessage( msg ){
        if( this.toast ){
          this.toast.text = msg;
          this.toast.show();
        }
      },

      _toastError( msg ){
        if( this.errorToast ){
          this.errorToast.text = msg;
          this.errorToast.show();
        }
      },

      _setErrorsInFields( returnObject ){
        var found;
        var form = this.form;
        if( form && returnObject.errors && Array.isArray( returnObject.errors ) ){

          for( var i = 0, l = returnObject.errors.length; i < l; i ++ ){
            var error = returnObject.errors[ i ];

            var domField = this.form.$$(`[name='${error.field}']`)
            if( domField ){
              domField.errorMessage = error.message;
              domField.invalid = true;
            }
          };
        }
      },

      _formError( e ){
        var returnObject = e.detail.request.xhr.response;
        this._toastError( returnObject.message );
        this._setErrorsInFields( returnObject );
      },

      _formSubmitted( e ){
        if( this.successMessage != '' ){
          this._toastMessage( this.successMessage );
        }
      },


      /*
      attached: function(){
        this.listen( this.form, 'iron-form-error', '_formError' );
      },
      detached: function(){
        this.unlisten( this.form, 'iron-form-error', '_formError' );
      },
      */

    });
  </script>
</dom-module>
